
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<dom-module id="game-dashboard">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <h1>Teams</h1>
        <iron-signals on-iron-signal-add-team='addTeam'></iron-signals>
        <iron-signals on-iron-signal-start-game='startGame'></iron-signals>
        <iron-signals on-iron-signal-stop-game='stopGame'></iron-signals>

        <table className='table table-bordered'>
            <thead>
            <tr>
                <th colSpan="2"></th>
                <th colSpan="5">Tax</th>
                <th colSpan="5">Discounts</th>
            </tr>
            <tr>
                <th>Name</th>
                <th>Capital</th>
                <th>IT</th>
                <th>BE</th>
                <th>NL</th>
                <th>FR</th>
                <th>ES</th>
                <th>IT</th>
                <th>BE</th>
                <th>NL</th>
                <th>FR</th>
                <th>ES</th>
            </tr>
            </thead>
            <tbody>
                <template is="dom-repeat" items="{{teams}}">
                    <tr>
                        <td><div>{{item.name}}</div></td>
                        <td><div>{{item.capital}}</div></td>
                    </tr>
                </template>
            </tbody>
        </table>

    </template>
    <script>
        (function() {
            'use strict';
          
            const overhead = 25;
            const bustLimit = 0;
            const tickInterval = 1000;
            const initialCapital = 650;

            function reduceCapital(self) {
                console.log("reduceCapital");
                self.teams
                    .map(team => Math.max(team.capital - overhead, bustLimit))
                    .forEach((newCapital, i) => self.set("teams." + i + ".capital", newCapital));
            }

            Polymer({
                is: 'game-dashboard',
                properties: {
                    teams: {
                        value: []
                    }
                },
                addTeam: function (e, detail){
                    const team = { name: detail.name, capital: initialCapital};
                    if (team != ''){
                        this.push('teams', team);
                    }
                },
                startGame: function(){
                    console.log("start game");
                    const self = this;
                    this.intervalHandle = setInterval(function(){
                        reduceCapital(self);
                    }, tickInterval);
                },
                stopGame: function(){
                    console.log("stop game");
                    if (this.intervalHandle) {
                        clearInterval(this.intervalHandle);
                        this.intervalHandle = null;
                    }
                }
            });
        })();
    </script>
</dom-module>
